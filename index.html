<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phishow Scorecard v1</title>
  <style>
    body {
      background-color: #0a0a0a;
      color: #33ff33;
      font-family: 'Courier New', Courier, monospace;
      margin: 0;
      padding: 20px;
    }
    .terminal {
      max-width: 1000px;
      margin: auto;
      border: 2px solid #33ff33;
      padding: 20px;
      background-color: #111;
      box-shadow: 0 0 10px #33ff33;
    }
    h1 {
      text-align: center;
      margin-bottom: 5px;
      color: #ff6600;
      text-shadow: 0 0 5px #ff6600;
    }
    h2 {
      text-align: center;
      margin-bottom: 5px;
      color: #00ccff;
      border-bottom: 1px solid #00ccff;
      padding-bottom: 5px;
    }
    .sys-msg {
      color: #ff3333;
      font-weight: bold;
    }
    select, button, input[type="text"] {
      background-color: #222;
      color: #33ff33;
      border: 1px solid #33ff33;
      padding: 5px;
      margin-top: 10px;
      font-family: inherit;
    }
    button:hover {
      background-color: #33ff33;
      color: #0a0a0a;
      cursor: pointer;
    }
    .instructions {
      border: 1px dashed #ff6600;
      padding: 10px;
      margin-bottom: 20px;
      background-color: #1a1a1a;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
    }
    th {
      background-color: #00ccff;
      color: #0a0a0a;
    }
    th, td {
      border: 1px solid #33ff33;
      padding: 8px;
      text-align: left;
    }
    tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    .show-notes {
      margin: 20px 0;
      padding: 10px;
      border: 1px solid #ff6600;
      background-color: #1a1a1a;
    }
    #show-rating {
      font-size: 1.2em;
      color: #ff6600;
    }
    .tab-container {
      margin-top: 20px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #33ff33;
    }
    .tab-button {
      background-color: #111;
      color: #33ff33;
      border: 1px solid #33ff33;
      padding: 10px 20px;
      cursor: pointer;
      margin-right: 5px;
      font-family: 'Courier New', Courier, monospace;
    }
    .tab-button.active {
      background-color: #33ff33;
      color: #111;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    #hidden-data {
      display: none;
    }
  </style>
</head>
<body>
  <div class="terminal">
    <h1>Phishow Scorecard v3.2</h1>
    <p><strong class="sys-msg">[SYS_MSG]</strong> Don't Suck at Phish</p>

    <!-- Tab Buttons -->
    <div class="tabs">
      <button class="tab-button active" onclick="showTab('scorecard')">Scorecard</button>
      <button class="tab-button" onclick="showTab('song-rankings')">Song Rankings</button>
      <button class="tab-button" onclick="showTab('show-ratings')">Show Ratings</button>
    </div>

    <!-- Scorecard Tab -->
    <div id="scorecard" class="tab-content active">
      <div class="instructions">
        <h2>ðŸ“‹ Instructions</h2>
        <ol>
          <li>Select a show date from the dropdown.</li>
          <li>Click <strong>Generate Setlist & Scorecard</strong> to fetch real data.</li>
          <li>Rate each song using the dropdown (1â€“5).</li>
          <li>Add personal notes for standout moments.</li>
          <li>Reflect, revise, and remember: Don't Suck at Phish.</li>
        </ol>
      </div>

      <label for="showdate">Select a Show Date:</label>
      <select id="showdate" name="showdate">
        <option value="">Loading shows...</option>
      </select>
      <button onclick="loadShow()">Generate Setlist & Scorecard</button>

      <div id="show-details"></div>
      <div id="show-notes"></div>
      <div id="setlist-table"></div>
      <button onclick="submitRatings()">Submit Ratings</button>
    </div>

    <!-- Song Rankings Tab -->
    <div id="song-rankings" class="tab-content">
      <h2>Song Rankings</h2>
      <div id="song-rankings-table">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <!-- Show Ratings Tab -->
    <div id="show-ratings" class="tab-content">
      <h2>Show Ratings</h2>
      <div id="show-ratings-table">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <!-- Hidden Data Storage -->
    <div id="hidden-data">
      <!-- This will store our JSON data -->
    </div>
  </div>

  <script>
    const apiKey = "10645D7F59011FFA82A";
    console.log('API Key:', apiKey);

    async function fetchShows() {
      try {
        console.log('Fetching shows...');
        // Changed the endpoint back to the one we know works
        const response = await fetch(`https://api.phish.net/v5/shows/artist/phish.json?apikey=${apiKey}`);
        const data = await response.json();
        
        console.log('API Response:', data); // Added to debug
    
        const showSelect = document.getElemententById('showdate');
        showSelect.innerHTML = '<option value="">-- Choose a date --</option>';
    
        if (data.data && Array.isArray(data.data)) {
          // Sort shows by date descending (most recent first)
          const sortedShows = data.data.sort((a, b) => 
            new Date(b.showdate) - new Date(a.showdate)
          );
    
          sortedShows.forEach(show => {
            const option = document.createElement('option');
            option.value = show.showdate;
            option.textContent = `${show.showdate} - ${show.venue}`;
            showSelect.appendChild(option);
          });
          console.log(`Added ${data.data.length} shows to dropdown`);
        } else {
          throw new Error('No show data received');
        }
      } catch (error) {
        console.error('Error fetching shows:', error);
        document.getElementById('showdate').innerHTML = 
          '<option value="">Error loading shows</option>';
      }
    }


    async function loadShow() {
      const date = document.getElementById("showdate").value;
      if (!date) return alert("Please select a show date.");

      try {
        console.log('Loading show for date:', date);
        
        const setlistUrl = `https://api.phish.net/v5/setlists/showdate/${date}.json?apikey=${apiKey}`;
        console.log('Setlist URL:', setlistUrl);
        
        const setlistResponse = await fetch(setlistUrl);
        const setlistResult = await setlistResponse.json();
        
        console.log('Setlist Response:', setlistResult);

        if (!setlistResult.data || setlistResult.data.length === 0) {
          throw new Error('No setlist data found for this date.');
        }

        // Get the first show data entry
        const showData = setlistResult.data[0];
        console.log('Show Data:', showData);

        // Show Details
        document.getElementById("show-details").innerHTML = `
          <h2>Show Details</h2>
          <p><strong>Date:</strong> ${showData.showdate || 'N/A'}</p>
          <p><strong>Venue:</strong> ${showData.venue || 'N/A'}</p>
          <p><strong>Location:</strong> ${showData.city || 'N/A'}, ${showData.state || 'N/A'}, ${showData.country || 'N/A'}</p>
        `;

        // Show Notes
        let notesHTML = `
          <div class="show-notes">
            <h2>Show Notes</h2>
            <p>${showData.setlistnotes || "No notes available for this show."}</p>
          </div>
        `;
        document.getElementById("show-notes").innerHTML = notesHTML;

        // Get the setlist data - parse it like the Power Query
        const setlistEntries = setlistResult.data;
        console.log('Setlist Entries:', setlistEntries);

        // Setlist & Scorecard
        let setlistHTML = `
          <h2>Setlist & Ratings</h2>
          <table>
            <thead>
              <tr>
                <th>Set</th>
                <th>Song</th>
                <th>Jam Chart</th>
                <th>Gap</th>
                <th>Rating (1-5)</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
        `;

        if (setlistEntries.length <= 1) {
          setlistHTML += '<tr><td colspan="6">No setlist data available for this show.</td></tr>';
        } else {
          // Skip the first entry as it's the show info
          for (let i = 1; i < setlistEntries.length; i++) {
            const entry = setlistEntries[i];
            setlistHTML += `
              <tr>
                <td>${entry.set || ''}</td>
                <td>${entry.song || ''}</td>
                <td>${entry.jamchart ? 'âœ“' : ''}</td>
                <td>${entry.gap || 'N/A'}</td>
                <td>
                  <select style="width: 60px;">
                    <option value="">--</option>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                  </select>
                </td>
                <td><input type="text" style="width: 100%;" placeholder="Add notes..."></td>
              </tr>
            `;
          }
        }

        setlistHTML += `
          </tbody>
        </table>
        <div style="margin-top: 20px; text-align: right;">
          <button onclick="calculateAverage()">Calculate Show Rating</button>
          <span id="show-rating" style="margin-left: 10px;"></span>
        </div>
        `;

        document.getElementById("setlist-table").innerHTML = setlistHTML;
        console.log('Setlist table generated');

      } catch (error) {
        console.error('Error details:', error);
        alert('Error loading show data: ' + error.message);
        document.getElementById("show-details").innerHTML = "<p>Error loading show details.</p>";
        document.getElementById("show-notes").innerHTML = "";
        document.getElementById("setlist-table").innerHTML = "";
      }
    }

    function calculateAverage() {
      const ratings = document.querySelectorAll('#setlist-table select');
      let sum = 0;
      let count = 0;

      ratings.forEach(select => {
        if (select.value) {
          sum += parseInt(select.value);
          count++;
        }
      });

      const average = count > 0 ? (sum / count).toFixed(2) : 'No ratings yet';
      document.getElementById('show-rating').innerHTML = `<strong>Show Rating:</strong> ${average}`;
    }

    function submitRatings() {
      const showDate = document.getElementById("showdate").value;
      const ratings = [];
      
      // Get all rating rows
      const rows = document.querySelectorAll('#setlist-table tbody tr');
      rows.forEach(row => {
        const song = row.cells[1].textContent;
        const rating = row.querySelector('select').value;
        const notes = row.querySelector('input[type="text"]').value;
        
        if (rating) {
          ratings.push({
            song: song,
            set: row.cells[0].textContent,
            rating: parseInt(rating),
            notes: notes,
            date: showDate
          });
        }
      });

      // Save the ratings
      storage.saveRatings(showDate, ratings);
      
      // Show confirmation
      alert('Ratings submitted successfully!');
    }

    function showTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    const storage = {
      saveRatings: function(showDate, ratings) {
        const data = this.getAllRatings();
        data[showDate] = ratings;
        localStorage.setItem('phishowRatings', JSON.stringify(data));
      },

      getAllRatings: function() {
        const data = localStorage.getItem('phishowRatings');
        return data ? JSON.parse(data) : {};
      },

      getSongRankings: function() {
        const allRatings = this.getAllRatings();
        // Process ratings to get song averages
        // Implementation to be added
      },

      getShowRankings: function() {
        const allRatings = this.getAllRatings();
        // Process ratings to get show averages
        // Implementation to be added
      }
    };

    // Initialize by fetching shows
    fetchShows();
  </script>
</body>
</html>
